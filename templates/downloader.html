{% extends "base.html" %}

{% block title %}„ÉÄ„Ç¶„É≥„É≠„Éº„ÉÄ„Éº - „ÉÅ„Éß„Ç≥Tube{% endblock %}

{% block extra_css %}
<style>
.downloader-container {
    max-width: 800px;
    margin: 0 auto;
}

.downloader-title {
    font-size: 28px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.downloader-card {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 24px;
}

.url-input-group {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
}

.url-input {
    flex: 1;
    padding: 16px 20px;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 16px;
    outline: none;
    transition: border-color 0.3s;
}

.url-input:focus {
    border-color: var(--accent-primary);
}

.url-input::placeholder {
    color: var(--text-secondary);
}

.fetch-btn {
    padding: 16px 32px;
    background: var(--accent-primary);
    border: none;
    border-radius: 12px;
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
}

.fetch-btn:hover {
    background: var(--accent-secondary);
    transform: translateY(-2px);
}

.fetch-btn:disabled {
    background: var(--text-secondary);
    cursor: not-allowed;
    transform: none;
}

.format-section {
    margin-bottom: 24px;
}

.format-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 16px;
    color: var(--text-primary);
}

.format-options {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.format-btn {
    padding: 12px 24px;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: 10px;
    color: var(--text-primary);
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.format-btn:hover {
    border-color: var(--accent-primary);
    background: rgba(139, 69, 19, 0.1);
}

.format-btn.active {
    border-color: var(--accent-primary);
    background: var(--accent-primary);
    color: #fff;
}

.video-preview {
    display: none;
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
}

.video-preview.show {
    display: block;
}

.preview-content {
    display: flex;
    gap: 20px;
}

.preview-thumbnail {
    width: 200px;
    aspect-ratio: 16/9;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
}

.preview-info {
    flex: 1;
}

.preview-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    line-height: 1.4;
}

.preview-channel {
    color: var(--text-secondary);
    font-size: 14px;
    margin-bottom: 4px;
}

.preview-duration {
    color: var(--text-secondary);
    font-size: 14px;
}

.watch-on-choco-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    padding: 10px 20px;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    color: #fff;
    text-decoration: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    transition: transform 0.2s, box-shadow 0.3s;
}

.watch-on-choco-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(139, 69, 19, 0.4);
}

.download-options {
    display: none;
    margin-top: 24px;
}

.download-options.show {
    display: block;
}

.quality-section {
    margin-bottom: 20px;
}

.quality-title {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 12px;
    color: var(--text-secondary);
}

.quality-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.quality-btn {
    padding: 10px 20px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
}

.quality-btn:hover {
    border-color: var(--accent-light);
}

.quality-btn.selected {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: #fff;
}

.download-btn-main {
    display: block;
    width: 100%;
    padding: 18px;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    border: none;
    border-radius: 12px;
    color: #fff;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.3s;
    text-align: center;
    text-decoration: none;
}

.download-btn-main:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(139, 69, 19, 0.4);
}

.download-btn-main:disabled {
    background: var(--text-secondary);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 20px;
}

.loading-spinner.show {
    display: block;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--border-color);
    border-top-color: var(--accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 12px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.error-message {
    display: none;
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.3);
    border-radius: 8px;
    padding: 16px;
    color: #dc3545;
    margin-bottom: 20px;
}

.error-message.show {
    display: block;
}

.info-box {
    background: rgba(139, 69, 19, 0.1);
    border: 1px solid rgba(139, 69, 19, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin-top: 24px;
}

.info-box-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.info-box ul {
    margin: 0;
    padding-left: 20px;
    color: var(--text-secondary);
}

.info-box li {
    margin-bottom: 6px;
    line-height: 1.5;
}

.method-section {
    margin-bottom: 24px;
}

.method-options {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.method-btn {
    padding: 14px 24px;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: 10px;
    color: var(--text-primary);
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    justify-content: center;
}

.method-btn:hover {
    border-color: var(--accent-primary);
    background: rgba(139, 69, 19, 0.1);
}

.method-btn.active {
    border-color: var(--accent-primary);
    background: var(--accent-primary);
    color: #fff;
}

.external-service-info {
    background: rgba(139, 69, 19, 0.1);
    border: 1px solid rgba(139, 69, 19, 0.3);
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 20px;
}

.external-service-info p {
    color: var(--text-secondary);
    font-size: 14px;
    margin: 0;
}

.external-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.download-btn-external {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 18px;
    border: none;
    border-radius: 12px;
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.3s;
    text-align: center;
    text-decoration: none;
    min-width: 180px;
}

.download-btn-external:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.download-btn-external.mp4-btn {
    background: linear-gradient(135deg, #4A90D9, #357ABD);
}

.download-btn-external.mp3-btn {
    background: linear-gradient(135deg, #50C878, #3CB371);
}

.download-btn-external.savefrom-btn {
    background: linear-gradient(135deg, #FF6B35, #E55934);
}

.download-buttons-container {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-top: 20px;
}

.download-btn-main.mp4-download {
    background: linear-gradient(135deg, #8B4513, #A0522D);
    flex: 1;
    min-width: 200px;
}

.download-btn-main.mp3-download {
    background: linear-gradient(135deg, #2ECC71, #27AE60);
    flex: 1;
    min-width: 200px;
}

.download-progress {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 20px;
    background: var(--bg-secondary);
    border-radius: 12px;
    margin-top: 20px;
}

.download-progress.show {
    display: flex;
}

.progress-spinner {
    width: 24px;
    height: 24px;
    border: 3px solid var(--border-color);
    border-top-color: var(--accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.progress-text {
    color: var(--text-primary);
    font-size: 15px;
}

@media (max-width: 768px) {
    .url-input-group {
        flex-direction: column;
    }
    
    .preview-content {
        flex-direction: column;
    }
    
    .preview-thumbnail {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="downloader-container">
    <h1 class="downloader-title">
        <span>üì•</span>
        ÂãïÁîª„ÉªÈü≥Â£∞„ÉÄ„Ç¶„É≥„É≠„Éº„ÉÄ„Éº
    </h1>
    
    <div class="downloader-card">
        <div class="url-input-group">
            <input type="text" class="url-input" id="videoUrl" placeholder="YouTubeÂãïÁîª„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..." autocomplete="off">
            <button class="fetch-btn" id="fetchBtn" onclick="fetchVideoInfo()">ÂèñÂæó</button>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <p>ÂãïÁîªÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...</p>
        </div>
        
        <div class="video-preview" id="videoPreview">
            <div class="preview-content">
                <img class="preview-thumbnail" id="previewThumbnail" src="" alt="Thumbnail">
                <div class="preview-info">
                    <h3 class="preview-title" id="previewTitle"></h3>
                    <p class="preview-channel" id="previewChannel"></p>
                    <p class="preview-duration" id="previewDuration"></p>
                    <a href="#" class="watch-on-choco-btn" id="watchOnChocoBtn">
                        <span>üç´</span> „ÉÅ„Éß„Ç≥Tube„ÅßË¶ã„Çã
                    </a>
                </div>
            </div>
        </div>
        
        <div class="download-options" id="downloadOptions">
            <div class="quality-section" id="videoQualitySection">
                <h4 class="quality-title">ÂãïÁîªÁîªË≥™„ÇíÈÅ∏Êäû</h4>
                <div class="quality-buttons" id="videoQualities">
                    <button class="quality-btn" data-quality="1080" onclick="selectQuality('1080')">1080p</button>
                    <button class="quality-btn selected" data-quality="720" onclick="selectQuality('720')">720p</button>
                    <button class="quality-btn" data-quality="480" onclick="selectQuality('480')">480p</button>
                    <button class="quality-btn" data-quality="360" onclick="selectQuality('360')">360p</button>
                </div>
            </div>
            
            <div class="download-buttons-container">
                <a href="#" class="download-btn-main mp4-download" id="downloadBtnMp4" onclick="startInternalDownload('mp4', event)">
                    <span>üé¨</span> MP4„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                </a>
                <a href="#" class="download-btn-main mp3-download" id="downloadBtnMp3" onclick="startInternalDownload('mp3', event)">
                    <span>üéµ</span> MP3„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                </a>
            </div>
            
            <div class="download-progress" id="downloadProgress">
                <div class="progress-spinner"></div>
                <p class="progress-text" id="progressText">„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„É™„É≥„ÇØ„ÇíÂèñÂæó‰∏≠...</p>
            </div>
        </div>
    </div>
    
    <div class="info-box">
        <h4 class="info-box-title">
            <span>‚ÑπÔ∏è</span>
            „ÅîÂà©Áî®„Å´„Å§„ÅÑ„Å¶
        </h4>
        <ul>
            <li>YouTubeÂãïÁîª„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åß„Åç„Åæ„Åô</li>
            <li>ÂãïÁîªÂΩ¢Âºè(MP4)„Å®Èü≥Â£∞ÂΩ¢Âºè(MP3)„ÇíÈÅ∏Êäû„Åß„Åç„Åæ„Åô</li>
            <li>Ëëó‰ΩúÊ®©„Å´ÈÖçÊÖÆ„Åó„Å¶„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ</li>
            <li>„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´„ÅØÊôÇÈñì„Åå„Åã„Åã„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentVideoId = '';
let selectedQuality = '720';

function extractVideoId(url) {
    const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
        /^([a-zA-Z0-9_-]{11})$/
    ];
    
    for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) return match[1];
    }
    return null;
}

function showError(message) {
    const errorEl = document.getElementById('errorMessage');
    errorEl.textContent = message;
    errorEl.classList.add('show');
}

function hideError() {
    document.getElementById('errorMessage').classList.remove('show');
}

function showLoading(show) {
    document.getElementById('loadingSpinner').classList.toggle('show', show);
    document.getElementById('fetchBtn').disabled = show;
}

async function fetchVideoInfo() {
    const url = document.getElementById('videoUrl').value.trim();
    if (!url) {
        showError('URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    const videoId = extractVideoId(url);
    if (!videoId) {
        showError('ÊúâÂäπ„Å™YouTube URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    hideError();
    showLoading(true);
    document.getElementById('videoPreview').classList.remove('show');
    document.getElementById('downloadOptions').classList.remove('show');
    
    try {
        const response = await fetch(`/api/video-info/${videoId}`);
        const data = await response.json();
        
        if (data.error) {
            showError(data.error);
            showLoading(false);
            return;
        }
        
        currentVideoId = videoId;
        
        document.getElementById('previewThumbnail').src = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;
        document.getElementById('previewTitle').textContent = data.title || '„Çø„Ç§„Éà„É´‰∏çÊòé';
        document.getElementById('previewChannel').textContent = data.author || '';
        document.getElementById('previewDuration').textContent = data.lengthText ? `ÂÜçÁîüÊôÇÈñì: ${data.lengthText}` : '';
        document.getElementById('watchOnChocoBtn').href = `/watch?v=${videoId}`;
        
        document.getElementById('videoPreview').classList.add('show');
        document.getElementById('downloadOptions').classList.add('show');
        
    } catch (error) {
        showError('ÂãïÁîªÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
    
    showLoading(false);
}

function selectQuality(quality) {
    selectedQuality = quality;
    document.querySelectorAll('.quality-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.quality === quality);
    });
}

function showDownloadProgress(show, message = '„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„É™„É≥„ÇØ„ÇíÂèñÂæó‰∏≠...') {
    const progressEl = document.getElementById('downloadProgress');
    const progressText = document.getElementById('progressText');
    progressText.textContent = message;
    progressEl.classList.toggle('show', show);
}

function startInternalDownload(format, event) {
    event.preventDefault();
    
    if (!currentVideoId) {
        showError('„Åæ„ÅöÂãïÁîªÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }
    
    hideError();
    showDownloadProgress(true, format === 'mp3' ? 'MP3„Çí‰ΩúÊàê‰∏≠Ôºà„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑÔºâ...' : 'MP4„Çí‰ΩúÊàê‰∏≠Ôºà„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑÔºâ...');
    
    const downloadUrl = `/api/internal-download/${currentVideoId}?format=${format}&quality=${selectedQuality}`;
    
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = downloadUrl;
    document.body.appendChild(iframe);
    
    setTimeout(() => {
        showDownloadProgress(false);
        document.body.removeChild(iframe);
    }, 60000);
}

document.getElementById('videoUrl').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        fetchVideoInfo();
    }
});
</script>
{% endblock %}
